apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-stream-conf
data:
  nginx.conf: |
    worker_processes auto;

    events {
      worker_connections 1024;
    }

    stream {
      resolver kube-dns.kube-system.svc.cluster.local valid=10s;

{{- range .Values.clients }}
      upstream {{ .name | replace "-" "_" }} {
        server minecraft-{{ .name }}.minecraft.svc.cluster.local:25565;
      }

      server {
        listen {{ .port }};
        proxy_pass {{ .name | replace "-" "_" }};
      }
{{- end }}
    }
